version: 2.1

orbs:
  orb-tools: circleci/orb-tools@12.3
  opifex-ordinis: {}

filters: &filters
  tags:
    only: /.*/

develop-filters: &develop-filters
  branches:
    only: [develop]

main-filters: &main-filters
  branches:
    only: [main]

jobs:
  command-tests:
    executor: opifex-ordinis/machine
    steps:
      - opifex-ordinis/full_checkout
      - run:
          name: Verify full checkout
          command: |
            test -d .git
            git log --oneline -5

  publish-dev-snapshot:
    docker:
      - image: circleci/circleci-cli:latest
    steps:
      - checkout
      - run:
          name: Pack and publish dev snapshot
          command: |
            circleci orb pack src > /tmp/orb.yml
            circleci orb validate /tmp/orb.yml
            circleci orb publish --token "${CIRCLE_TOKEN}" /tmp/orb.yml kof22/opifex-ordinis@dev:snapshot
            echo "Published kof22/opifex-ordinis@dev:snapshot"

  publish-production:
    docker:
      - image: circleci/circleci-cli:latest
    steps:
      - checkout
      - add_ssh_keys
      - run:
          name: Calculate version and publish
          command: |
            git fetch --tags
            LATEST=$(git tag -l 'v*' | sort -V | tail -1)
            LATEST=${LATEST:-v0.0.0}
            LATEST_CLEAN=${LATEST#v}

            BUMP="patch"
            COMMITS=$(git log "${LATEST}..HEAD" --pretty=%s 2>/dev/null || git log --pretty=%s -10)
            if echo "${COMMITS}" | grep -qi '\[major\]'; then
              BUMP="major"
            elif echo "${COMMITS}" | grep -qi '\[minor\]'; then
              BUMP="minor"
            fi

            IFS='.' read -r MAJOR MINOR PATCH \<<< "${LATEST_CLEAN}"
            case "${BUMP}" in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch) PATCH=$((PATCH + 1)) ;;
            esac
            VERSION="${MAJOR}.${MINOR}.${PATCH}"

            echo "Latest: ${LATEST} | Bump: ${BUMP} | Next: ${VERSION}"

            circleci orb pack src > /tmp/orb.yml
            circleci orb validate /tmp/orb.yml
            circleci orb publish --token "${CIRCLE_TOKEN}" /tmp/orb.yml "kof22/opifex-ordinis@${VERSION}"

            git config user.email "ci@kof22.com"
            git config user.name "CircleCI"
            git tag -a "v${VERSION}" -m "Release v${VERSION}"
            git push origin "v${VERSION}"

            echo "Published kof22/opifex-ordinis@${VERSION}"

workflows:
  test-deploy:
    jobs:
      - command-tests:
          filters: *filters
      - publish-dev-snapshot:
          context: orb-publishing
          filters: *develop-filters
          requires: [command-tests]
      - publish-production:
          context: orb-publishing
          filters: *main-filters
          requires: [command-tests]
